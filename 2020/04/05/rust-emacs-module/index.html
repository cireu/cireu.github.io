<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>用Rust扩展Emacs功能 | NIL</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.f49217e9.css" as="style"><link rel="preload" href="/assets/js/app.18bcd6af.js" as="script"><link rel="preload" href="/assets/js/4.3623162e.js" as="script"><link rel="preload" href="/assets/js/5.01fa82bf.js" as="script"><link rel="preload" href="/assets/js/16.1d243b02.js" as="script"><link rel="prefetch" href="/assets/js/1.8cf47d9f.js"><link rel="prefetch" href="/assets/js/10.9c95be4e.js"><link rel="prefetch" href="/assets/js/11.1d1a5d83.js"><link rel="prefetch" href="/assets/js/12.e06dd46f.js"><link rel="prefetch" href="/assets/js/13.82bd8097.js"><link rel="prefetch" href="/assets/js/14.a4f4c54e.js"><link rel="prefetch" href="/assets/js/15.52fc6e9d.js"><link rel="prefetch" href="/assets/js/17.059975a5.js"><link rel="prefetch" href="/assets/js/18.8cc69377.js"><link rel="prefetch" href="/assets/js/19.ecc651c2.js"><link rel="prefetch" href="/assets/js/20.7db988d4.js"><link rel="prefetch" href="/assets/js/21.0ba8fddc.js"><link rel="prefetch" href="/assets/js/6.b4898728.js"><link rel="prefetch" href="/assets/js/7.4032b5ee.js"><link rel="prefetch" href="/assets/js/8.843bf780.js"><link rel="prefetch" href="/assets/js/9.c18d5d6f.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.c949d70e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f49217e9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuperess-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">NIL
        </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">首页</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="nav-item"><a href="/about.html" class="nav-link">关于</a></li><li class="nav-item"><a href="/links.html" class="nav-link">友情链接</a></li><li class="nav-item"><a href="https://cireu.github.io/rss.xml" target="_blank" rel="noopener noreferrer" class="nav-link external">RSS</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">NIL
      </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="/about.html" class="nav-link">关于</a></li><li class="mobile-nav-item"><a href="/links.html" class="nav-link">友情链接</a></li><li class="mobile-nav-item"><a href="https://cireu.github.io/rss.xml" target="_blank" rel="noopener noreferrer" class="nav-link external">RSS</a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuperess-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content__default"><h1 id="用rust扩展emacs功能"><a href="#用rust扩展emacs功能" class="header-anchor">#</a> 用 Rust 扩展 Emacs 功能</h1> <h2 id="摘要"><a href="#摘要" class="header-anchor">#</a> 摘要</h2> <p>在 Emacs 25 中，Emacs 引入了『动态模块』（dynamic module）的机制，允许开发者使用 C
 语言规定的动态链接库格式扩展 Emacs 本身所缺乏的能力。</p> <p>本文阐释了使用 Rust 开发动态模块相对于 C 语言的优势，并介绍讲解如何使用
<a href="https://github.com/ubolonton/emacs-module-rs" target="_blank" rel="noopener noreferrer"> ubolonto<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 开发的
<a href="https://github.com/ubolonton/emacs-module-rs" target="_blank" rel="noopener noreferrer"> emacs-module-rs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 简化 Rust 动态模组开发
流程。</p> <h2 id="为什么选择rust而不是c"><a href="#为什么选择rust而不是c" class="header-anchor">#</a> 为什么选择 Rust 而不是 C</h2> <p>C 语言作为一门上世纪 70 年代发明的编程语言，其历史局限性十分严重。可以认为，C 语言的
一些缺陷，阻碍了动态模块这一扩展方式的流行。</p> <ul><li>语言本身过于底层，缺乏表达能力，需要浪费精力在内存管理上。对聚焦于代码逻辑本身
的快速开发不够方便。</li> <li>缺乏良好的类型约束，容易写出内存不安全的代码。</li> <li>缺少中心化的包分发管理系统，获取构建依赖十分麻烦。</li> <li>不同用户上的 C 语言编译器和 C 语言运行时不同，在用户构建使用时容易出现难以复现的
 BUG</li></ul> <p>Rust 作为一门新时代的，聚焦于内存安全，底层效率以及并发的语言，正好完美解决了 C 语
言带来的这些痛点。</p> <ul><li>Rust 本身支持最常用的三大操作系统，代码和构建系统无须做过多调整即可跨平台使用。</li> <li>Rust 与 C 之间有良好的互操作性，即使需要调用 C 语言轮子也不会过于繁琐。</li> <li>Rust 使得开发者在编写动态模组时无需像 C 语言一样为了处理内存细节而烦恼。可
以集中精神在代码逻辑上。</li> <li>Emacs module 的 Rust 绑定具有良好的抽象封装，避免了直接与 <code>emacs_module.h</code>  里定义的
底层函数交互的繁琐细节。</li> <li>Rust 具有优秀的社区生态，可以复用大量开源社区的轮子，节约了开发时间。</li></ul> <h2 id="目标读者群"><a href="#目标读者群" class="header-anchor">#</a> 目标读者群</h2> <p>本文假定你有一定的 Rust 和 Elisp 编程经验。如果你没有，可以先从这里开始</p> <ul><li><a href="https://github.com/rust-lang-cn/rust-by-example-cn" target="_blank" rel="noopener noreferrer">Rust by Example（中文）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.gnu.org/software/emacs/manual/eintr.html" target="_blank" rel="noopener noreferrer">An Introduction to Programming in Emacs Lisp（英
文）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="环境"><a href="#环境" class="header-anchor">#</a> 环境</h2> <p>本节记录写下本文所用的操作系统以及相关软件的版本</p> <ul><li><code>Archlinux</code></li> <li><code>Emacs 26.3</code></li> <li><code>rustc 1.41.1 (f3e1a954d 2020-02-24)</code></li> <li><code>clang 9.0.1</code></li> <li><code>llvm 9.0.1</code></li></ul> <h2 id="初试牛刀"><a href="#初试牛刀" class="header-anchor">#</a> 初试牛刀</h2> <h3 id="创建项目"><a href="#创建项目" class="header-anchor">#</a> 创建项目</h3> <p>执行下列命令创建一个空白 Rust 项目</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>cargo init --lib greeting
<span class="token builtin class-name">cd</span> greeting
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修改  <code>Cargo.toml</code>  文件</p> <div class="language-toml line-numbers-mode"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span>
<span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">&quot;greeting&quot;</span>
<span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.1.0&quot;</span>
<span class="token key property">edition</span> <span class="token punctuation">=</span> <span class="token string">&quot;2018&quot;</span>
<span class="token comment"># 我们通常希望把 Emacs 相关的 package 发布在 ELPA 而不是 crates.io 上</span>
<span class="token key property">publish</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>

<span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span>
<span class="token comment"># 重要，否则 Rust 不会生成兼容 C ABI 的动态库</span>
<span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;cdylib&quot;</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token comment"># 重要，创建 Emacs 动态模块的关键依赖</span>
<span class="token key property">emacs</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.13&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="编码"><a href="#编码" class="header-anchor">#</a> 编码</h3> <p><code>src/lib.rs</code></p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">emacs<span class="token punctuation">::</span></span><span class="token punctuation">{</span>defun<span class="token punctuation">,</span> <span class="token class-name">Env</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个 C int 类型的名为 plugin_is_GPL_compatible 的全局变量，否则 Emacs 会拒绝加</span>
<span class="token comment">// 载模块 :)</span>
<span class="token namespace">emacs<span class="token punctuation">::</span></span><span class="token macro property">plugin_is_GPL_compatible!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义模块入口，大部份情况我们不需要它做任何事。</span>
<span class="token attribute attr-name">#[emacs::module]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Env</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 输出一条你好信息</span>
<span class="token attribute attr-name">#[defun]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">say_hello</span><span class="token punctuation">(</span>env<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Env</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    env<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, {}!&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="编译"><a href="#编译" class="header-anchor">#</a> 编译</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>cargo build

<span class="token comment"># 对于名为 libxxx 的动态库文件，须更名为 crate 的命名，以保证 emacs-module-rs 生</span>
<span class="token comment"># 成的 provide form 提供的 feature 与文件名相同</span>

<span class="token comment"># Linux </span>
<span class="token function">ln</span> -sv target/debug/libgreeting.so greeting.so

<span class="token comment"># Mac</span>
<span class="token function">ln</span> -sv target/debug/libgreeting.dylib greeting.so

<span class="token comment"># Windows</span>
<span class="token comment"># Windows10 默认禁止一般用户创建软链接，你可以参照</span>
<span class="token comment"># https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/create-symbolic-links </span>
<span class="token comment"># 为你自己启用软链接创造权限，这里使用硬链接作为替代。</span>
mklink target/debug/greeting.dll greeting.dll
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="加载运行"><a href="#加载运行" class="header-anchor">#</a> 加载运行</h3> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">add-to-list</span> <span class="token quoted-symbol variable symbol">'load-path</span> <span class="token string">&quot;&lt;path/to/your/project/&gt;&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">require</span> <span class="token quoted-symbol variable symbol">'greeting</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">greeting-say-hello</span> <span class="token string">&quot;Emacs&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>若一切顺利，minibuffer 会弹出信息  <code>Hello, Emacs!</code></p> <h2 id="emacs-value"><a href="#emacs-value" class="header-anchor">#</a> <code>emacs::Value</code></h2> <p><code>emacs::Value</code>  是在 Rust 表示 Elisp 值的代理类型，每个  <code>Value</code>  代表一个对 Elisp
 值的引用。由于具体的内存分配实际上是 Elisp VM 的 GC 在管理， <code>Value</code>  在 Rust 里的拷贝和
移动是十分轻量的（因此实现了  <code>Copy</code>  trait）。</p> <p>Rust 无法直接利用一个  <code>Value</code> ，只有  <code>emacs-module.h</code>  提供了转换函数的的基本类型可
以用于转换。在底层函数之上， <code>emacs-module-rs</code>  又提供了  <code>IntoLisp</code>  和 <code>FromLisp</code> 
trait 用于抽象 Rust 类型到  <code>Value</code>  之间的转换。</p> <p>下列类型实现了这些 traits。你也可以为自定义类型实现这些 traits 来实现复杂数据的转换。</p> <ul><li><code>Value</code>  对应自己 😛</li> <li><code>i64</code>  对应一个 Elisp fixnum（64 位有符号整型</li> <li><code>f64</code>  对应一个 Elisp float（64 位双精度浮点）</li> <li><code>String</code>  对应一个 Elisp 字符串（不含 text property）</li> <li><code>emacs::Vector</code>  对应一个 Elisp 向量</li> <li><code>()</code>  对应 Elisp 的  <code>nil</code></li> <li><code>Option&lt;T&gt;</code>  对应一个可为  <code>nil</code>  的 Elisp 值，具体类型由  <code>T</code>  决定</li></ul> <h2 id="defun"><a href="#defun" class="header-anchor">#</a> <code>#[defun]</code></h2> <p><code>emacs::defun</code>  是  <code>emacs-module-rs</code>  最主要的魔法，这个属性宏修饰一个 Rust 的函数
定义，使其转变为可以在 Elisp VM 里调用的模块函数。</p> <p>被修饰的函数可以接收任意数量的所有权类型，且类型实现了 <code>FromLisp</code>  trait 的参数，最终返回
 <code>emacs::Result&lt;T&gt;</code>  其中  <code>T</code>  实现 <code>IntoLisp</code>  trait。简化了返回和取用 Elisp 值时手动转型的
模板代码。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// 一个愚蠢但是简单的例子，这个注释会被导入 Emacs 的帮助系统中，</span>
<span class="token comment">/// 通过 M-x describe-function 查阅。</span>
<span class="token attribute attr-name">#[defun]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token keyword">i64</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token keyword">i64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">emacs<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">i64</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>lhs <span class="token operator">+</span> rhs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="命名修饰"><a href="#命名修饰" class="header-anchor">#</a> 命名修饰</h3> <p>Elisp 缺乏命名空间系统，每个包都拥有自己的命名前缀来防止产生命名冲突。
 <code>emacs-module-rs</code>  导出的 Elisp 函数的命名修饰格式为  <code>&lt;包名&gt;[相对于crate的Rust模块路 径名]&lt;函数名&gt;</code></p> <p>Rust 的 snake_case 风格命名会被转换成 kebab-case 的 Lisp 风格命名，表示路径的
 <code>::</code>  也会被转换为 Lisp 风格的  <code>-</code></p> <h2 id="调用elisp函数"><a href="#调用elisp函数" class="header-anchor">#</a> 调用 Elisp 函数</h2> <h3 id="调用全局静态函数"><a href="#调用全局静态函数" class="header-anchor">#</a> 调用全局静态函数</h3> <p><code>emacs::Env</code>  类型上静态挂载了常用的 Elisp 函数，这些函数通常都是  <code>emacs-module.h</code> 
 直接暴露出来的。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code>env<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token string">&quot;defun&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">type_of</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">.</span><span class="token function">into_lisp</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&quot;my-module&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>要捕捉一个  <code>Env</code>  来调用这些函数，请在  <code>defun</code>  修饰的函数定义里额外加入一个类型为
 <code>&amp;Env</code>  的参数。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// 是的，这函数将一个字符串 intern 为 Elisp symbol。但是你为什么不直接在 Elisp 里</span>
<span class="token comment">/// 用 intern 呢</span>
<span class="token attribute attr-name">#[defun]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">silly_intern</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'e</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>env<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'e</span> <span class="token class-name">Env</span><span class="token punctuation">,</span> s<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">emacs<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'e</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    env<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="调用任意函数"><a href="#调用任意函数" class="header-anchor">#</a> 调用任意函数</h3> <p><code>emacs::Env::call(func, args)</code>  可以调用任意 Elisp 函数，其中</p> <ul><li><code>func</code>  可为标识函数名的字符串（调用对应的  <code>symbol-function</code> ），或者可调用的
 <code>Value</code>  （如闭包）</li> <li><code>args</code>  可为一个  <code>&amp;[Value]</code>  类型，或者一个包含了 1-12（受限于实现，暂时上限 12 个）
个元素，且每个元素都实现了  <code>IntoLisp</code>  trait 的元组</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// (list &quot;str&quot; 2)</span>
env<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>


<span class="token keyword">let</span> list <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token string">&quot;list&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token comment">// (symbol-function 'list)</span>
<span class="token keyword">let</span> subr <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;symbol-function&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>list<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token comment">// (funcall 'list &quot;str&quot; 2)</span>
env<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token comment">// (funcall (symbol-function 'list) &quot;str&quot; 2)</span>
env<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>subr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
subr<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;str&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// 简写</span>

<span class="token comment">// (add-hook 'text-mode-hook 'variable-pitch-mode)</span>
env<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;add-hook&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    env<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token string">&quot;text-mode-hook&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
    env<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token string">&quot;variable-pitch-mode&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// 将一个 Elisp Vector 转换为 Elisp List</span>
<span class="token attribute attr-name">#[defun]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">listify_vec</span><span class="token punctuation">(</span>vector<span class="token punctuation">:</span> <span class="token class-name">Vector</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> args <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">{</span>
        args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    vector<span class="token number">.0</span><span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div> <h2 id="向elisp-vm嵌入rust复合数据类型"><a href="#向elisp-vm嵌入rust复合数据类型" class="header-anchor">#</a> 向 Elisp VM 嵌入 Rust 复合数据类型</h2> <p>将一个 Rust 的复合数据类型完整转换为 Elisp 里的数据类型往往很困难。另一方面，在 Rust
 线程和 Elisp VM 间反复进行数据转换会降低模块执行的效率。因此，Elisp 提供 <code>user-ptr</code> 
 类型用于承载对 Elisp 不透明的外部类型实例。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>为了使导出的自定义类型有意义，你还需要额外编写操作该数据类型的模块函数。</p></div> <p><code>user-ptr</code>  类型的释放由 Elisp VM 的 GC 托管，比起一般 Rust 复合数据类型有额外约束：</p> <ul><li><code>user-ptr</code>  类型实例必须位于堆上</li> <li><code>user-ptr</code>  类型具体生命周期编译时不可推断，被移动进 Elisp VM 的复合数据类型
必须满足  <code>'static</code>  生命周期约束</li> <li>由于无法重新获得所有权，Rust 只能用不可变引用访问  <code>user-ptr</code>  类型，常常需要使用
内部可变性（单线程  <code>RefCell</code> ，多线程锁机制，原子类型等）</li></ul> <p>在非多 Rust 线程的情况下， <code>emacs-module-rs</code>  的  <code>#[defun]</code>  宏可以简化大部份样板代
码。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">emacs<span class="token punctuation">::</span></span><span class="token punctuation">{</span>defun<span class="token punctuation">,</span> <span class="token class-name">Env</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[emacs::module(name = <span class="token string">&quot;rs-hash-map&quot;</span>, separator = <span class="token string">&quot;/&quot;</span>)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span>env<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Env</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Map</span> <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">// 标记函数返回一个用 RefCell 包裹的 user-ptr 类型</span>
    <span class="token comment">// #[defun] 宏会自动将其包裹成 Box&lt;RefCell&lt;Map&gt;&gt;</span>
    <span class="token attribute attr-name">#[defun(user_ptr)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Map</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在 #[defun] 的参数中，引用类型总表示由 #[defun(user-ptr)] 嵌入的 user-ptr</span>
    <span class="token comment">// 的实例的引用</span>
    <span class="token attribute attr-name">#[defun]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span>map<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Map</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">String</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[defun]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">set</span><span class="token punctuation">(</span>map<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Map</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">m</span> <span class="token punctuation">(</span><span class="token car">rs-hash-map/make</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">rs-hash-map/get</span> m <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>     <span class="token comment">; -&gt; nil</span>

  <span class="token punctuation">(</span><span class="token car">rs-hash-map/set</span> m <span class="token string">&quot;a&quot;</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token comment">; -&gt; nil</span>
  <span class="token punctuation">(</span><span class="token car">rs-hash-map/get</span> m <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>     <span class="token comment">; -&gt; &quot;1&quot;</span>

  <span class="token punctuation">(</span><span class="token car">rs-hash-map/set</span> m <span class="token string">&quot;a&quot;</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span> <span class="token comment">; -&gt; &quot;1&quot;</span>
  <span class="token punctuation">(</span><span class="token car">rs-hash-map/get</span> m <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">; -&gt; &quot;2&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h2> <h3 id="在rust中处理elisp错误"><a href="#在rust中处理elisp错误" class="header-anchor">#</a> 在 Rust 中处理 Elisp 错误</h3> <div class="custom-block warning"><p class="custom-block-title">警告</p> <p><strong>强烈不建议在 Rust 代码中处理 Elisp 代码的错误！</strong> 在 Rust 代码中处理可能
的 Elisp 的错误繁琐且容易造成内存不安全（涉及 unsafe 代码）。请直接使用  <code>?</code>  操作符向
上抛出在 Rust 代码中调用 Elisp 代码时可能的抛错。这些错误最终会以 <code>rust-error</code>  的错误
类型暴露给 Elisp VM。</p></div> <h3 id="在elisp代码中处理rust错误"><a href="#在elisp代码中处理rust错误" class="header-anchor">#</a> 在 Elisp 代码中处理 Rust 错误</h3> <p><code>emacs-module-rs</code>  暴露了两种错误类型供用户在 Elisp 端用 <code>condition-case</code>  处理。</p> <ul><li><code>rust-error</code>  所有由 Rust 制造的错误。</li> <li><code>rust-wrong-type-user-ptr</code>  当尝试把一个 lisp 值转换为一个 user-ptr 在 Rust 里的值时，
若类型不匹配，则抛出该错误。该错误是  <code>rust-error</code>  的子类型错误。</li></ul> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// 如果 value 内含有的不是 RefCell&lt;HashMap&lt;String, String&gt;&gt;，或者甚至不是一个</span>
<span class="token comment">// user-ptr，Elisp 端会抛出一个 rust-wrong-type-user-ptr 错误。</span>
<span class="token keyword">let</span> r<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">into_rust</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>如果你需要在 Rust 代码里抛出类型更精确的 Elisp 错误，可以尝试在 Rust 里调用 Elisp 函数
 <code>signal</code>  。</p> <div class="language-rust line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[emacs::module(name = <span class="token string">&quot;test&quot;</span>)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Env</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[defun]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">signal_wrong_type</span><span class="token punctuation">(</span>e<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Env</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">&quot;Mismatched type!&quot;</span><span class="token punctuation">.</span><span class="token function">to_owned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;signal&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token string">&quot;wrong-type-argument&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token macro property">unreachable!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">condition-case</span> e
    <span class="token punctuation">(</span><span class="token car">test-signal-wrong-type</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">wrong-type-argument</span>
   <span class="token punctuation">(</span><span class="token keyword">message</span> <span class="token punctuation">(</span><span class="token car">error-message-string</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;; =&gt; &quot;Wrong type argument: \&quot;Mismatched type!\&quot;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <h3 id="在elisp中处理rust-panic"><a href="#在elisp中处理rust-panic" class="header-anchor">#</a> 在 Elisp 中处理 Rust panic</h3> <div class="custom-block warning"><p class="custom-block-title">警告</p> <p>跨越 FFI 边界的 unwind 是一个 <strong>未定义行为</strong>。 <code>emacs-module-rs</code>  会尝试用
 <code>catch_unwind</code>  捕捉 panic，遗憾的是这并不总奏效－－有的 panic 根本不使用 unwind 实现！
 <code>catch_unwind</code>  可以捕捉到的 panic 会变成一个 Elisp 错误，而无法捕捉的错误其行为则
依赖于具体实现（如调用 abort 实现 panic 会把你的 Emacs 连带崩掉 😛）</p> <p>panic 常代表不可恢复的错误，表明程序的逻辑出了问题。尽管有办法在 Elisp 中捕捉一个
 Rust panic，但我不会在这里教你怎么做－－比起掩盖错误的发生，更应该找出错误的原
因。</p></div> <h3 id="rust错误之间的互相处理"><a href="#rust错误之间的互相处理" class="header-anchor">#</a> Rust 错误之间的互相处理</h3> <p><code>emacs-module-rs</code>  本身使用
<a href="https://github.com/rust-lang-nursery/failure" target="_blank" rel="noopener noreferrer"> failure<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 库处理错误。如果你恰好
也使用了 failure 处理错误，可以直接使用  <code>?</code>  操作符抛出你的错误，
 <code>emacs-module-rs</code>  会将其统一处理为  <code>rust-error</code>  类型的 Elisp 错误抛出给 Elisp VM。</p> <p>其他类型的错误，在转换为  <code>failure::Error</code>  后也可以按同样的方式抛出给 Elisp VM。</p> <h2 id="延伸阅读"><a href="#延伸阅读" class="header-anchor">#</a> 延伸阅读</h2> <p>本文对编程动态模块中不常见的细节做了部分省略以保证作为入门读物的可读性，要完整的
理解 <code>emacs-module-rs</code>  ，请移步<a href="https://ubolonton.github.io/emacs-module-rs/latest/" target="_blank" rel="noopener noreferrer"> emacs-module-rs's user guide（英
文）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>要更深入理解 Rust 语言以及  <code>emacs-module-rs</code>  背后的魔法，阅读 Rust 官网提供的教程是
不错的选择。</p> <ul><li><a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener noreferrer">The Rust Programming Language（英文）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://doc.rust-lang.org/nomicon" target="_blank" rel="noopener noreferrer">Rust Nomicon（英文）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>下列是一些用 Rust 构建动态模块的 Emacs 插件列表，也许可以在你写新模块的时候
帮助到你。</p> <ul><li><a href="https://github.com/rustify-emacs/fuz.el" target="_blank" rel="noopener noreferrer">fuz.el<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/ubolonton/emacs-tree-sitter" target="_blank" rel="noopener noreferrer">emacs-tree-sitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <hr> <!----></div> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#摘要" title="摘要">摘要</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#为什么选择rust而不是c" title="为什么选择Rust而不是C">为什么选择Rust而不是C</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#目标读者群" title="目标读者群">目标读者群</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#环境" title="环境">环境</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#初试牛刀" title="初试牛刀">初试牛刀</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#创建项目" title="创建项目">创建项目</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#编码" title="编码">编码</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#编译" title="编译">编译</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#加载运行" title="加载运行">加载运行</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#emacs-value" title="emacs::Value">emacs::Value</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#defun" title="#[defun]">#[defun]</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#命名修饰" title="命名修饰">命名修饰</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#调用elisp函数" title="调用Elisp函数">调用Elisp函数</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#调用全局静态函数" title="调用全局静态函数">调用全局静态函数</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#调用任意函数" title="调用任意函数">调用任意函数</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#向elisp-vm嵌入rust复合数据类型" title="向Elisp VM嵌入Rust复合数据类型">向Elisp VM嵌入Rust复合数据类型</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#错误处理" title="错误处理">错误处理</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#在rust中处理elisp错误" title="在Rust中处理Elisp错误">在Rust中处理Elisp错误</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#在elisp代码中处理rust错误" title="在Elisp代码中处理Rust错误">在Elisp代码中处理Rust错误</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#在elisp中处理rust-panic" title="在Elisp中处理Rust panic">在Elisp中处理Rust panic</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#rust错误之间的互相处理" title="Rust错误之间的互相处理">Rust错误之间的互相处理</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#延伸阅读" title="延伸阅读">延伸阅读</a></div></div></div></div> <footer class="footer" data-v-5317f8db><div class="footer-left-wrap" data-v-5317f8db><ul class="contact" data-v-5317f8db></ul></div> <div class="footer-right-wrap" data-v-5317f8db><ul class="copyright" data-v-5317f8db></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.18bcd6af.js" defer></script><script src="/assets/js/4.3623162e.js" defer></script><script src="/assets/js/5.01fa82bf.js" defer></script><script src="/assets/js/16.1d243b02.js" defer></script>
  </body>
</html>
