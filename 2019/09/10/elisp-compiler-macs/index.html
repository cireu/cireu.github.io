<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浅析 emacs-lisp 中的 compiler-macro | NIL</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8d7c9c93.css" as="style"><link rel="preload" href="/assets/js/app.1bc9c4b2.js" as="script"><link rel="preload" href="/assets/js/4.3623162e.js" as="script"><link rel="preload" href="/assets/js/5.01fa82bf.js" as="script"><link rel="preload" href="/assets/js/13.82bd8097.js" as="script"><link rel="prefetch" href="/assets/js/1.8cf47d9f.js"><link rel="prefetch" href="/assets/js/10.9c95be4e.js"><link rel="prefetch" href="/assets/js/11.1d1a5d83.js"><link rel="prefetch" href="/assets/js/12.e06dd46f.js"><link rel="prefetch" href="/assets/js/14.a4f4c54e.js"><link rel="prefetch" href="/assets/js/15.52fc6e9d.js"><link rel="prefetch" href="/assets/js/16.1379f379.js"><link rel="prefetch" href="/assets/js/17.059975a5.js"><link rel="prefetch" href="/assets/js/18.8cc69377.js"><link rel="prefetch" href="/assets/js/19.ecc651c2.js"><link rel="prefetch" href="/assets/js/20.75ac69b7.js"><link rel="prefetch" href="/assets/js/21.0ba8fddc.js"><link rel="prefetch" href="/assets/js/6.b4898728.js"><link rel="prefetch" href="/assets/js/7.4032b5ee.js"><link rel="prefetch" href="/assets/js/8.843bf780.js"><link rel="prefetch" href="/assets/js/9.c18d5d6f.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.c949d70e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8d7c9c93.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuperess-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">NIL
        </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">首页</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="nav-item"><a href="/about.html" class="nav-link">关于</a></li><li class="nav-item"><a href="/links.html" class="nav-link">友情链接</a></li><li class="nav-item"><a href="https://cireu.github.io/rss.xml" target="_blank" rel="noopener noreferrer" class="nav-link external">RSS</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">NIL
      </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="/about.html" class="nav-link">关于</a></li><li class="mobile-nav-item"><a href="/links.html" class="nav-link">友情链接</a></li><li class="mobile-nav-item"><a href="https://cireu.github.io/rss.xml" target="_blank" rel="noopener noreferrer" class="nav-link external">RSS</a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuperess-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content__default"><h1 id="浅析-emacs-lisp-中的-compiler-macro"><a href="#浅析-emacs-lisp-中的-compiler-macro" class="header-anchor">#</a> 浅析 emacs-lisp 中的 compiler-macro</h1> <h2 id="什么是-compiler-macro"><a href="#什么是-compiler-macro" class="header-anchor">#</a> 什么是 compiler macro</h2> <p>在 Elisp 里，我们通常会使用两种构造抽象的方式，macro 和 function. 这两者的区别相信读
者都已经了然于胸 (如果你不清楚，建议查阅 Elisp Reference Manual).</p> <p>简言之，compiler macro 可以在字节码编译时用特定的规则展开行如 <code>(func arg1 arg2 arg3)</code> 
 的函数调用，宏调用不会被 compiler macro 展开，因为你可以在宏体里直接指定代码变换的
方式，无需借助 compiler maro 的威力 :​).</p> <p>注意：通常来说只有标准形式 <code>(func arg1 arg2)</code>  的函数调用才会被 compiler macro 打开优
化，类似 <code>mapcar</code>  或者 <code>apply</code> <code>funcall</code>  的高阶函数调用，compiler macro 将无能为力</p> <p>是不是听着很熟悉？是的，compiler macro 可以做到内联优化，尽管 Elisp 编译器很笨拙，但
所幸他给我们这些性能狂人留下了很多手动操作的空间.</p> <p>compiler macro 并不能算作与 macro 和 function 类比的组织抽象的方式，只能算作 Elisp 为
我们提供的函数优化器，它没有自己独立的语义，而是依附于函数而存在.</p> <div class="custom-block warning"><p class="custom-block-title">警告</p> <p>一个例外是 <code>(funcall #'func 1 2)</code>  或者 <code>(apply #'func '(1 2 3 4))</code> , byte-compiler
 会消除掉这种 <code>funcall</code>  或者 <code>apply</code> , 然后交给 compiler macro 展开.</p></div> <h2 id="如何察看compiler-macro的展开结果"><a href="#如何察看compiler-macro的展开结果" class="header-anchor">#</a> 如何察看 compiler macro 的展开结果</h2> <h3 id="macroexpand"><a href="#macroexpand" class="header-anchor">#</a> macroexpand</h3> <p><code>macroexpand</code> <code>macroexpand-1</code> <code>macroexpand-all</code>  可以打开直接 compiler macro.</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code>ELISP&gt; <span class="token punctuation">(</span><span class="token car">macroexpand-all</span> <span class="token punctuation">'(</span><span class="token car">cadr</span> <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">car</span>
 <span class="token punctuation">(</span><span class="token car">cdr</span>
  <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里用 <code>cadr</code>  举例子，cadr 可以取出列表中第二个元素，等效于取列表的 <code>cdr</code>  的 <code>car</code> .
 可以看出来 compiler macro 直接把 cadr 展开成 <code>(car (cdr x))</code></p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code>ELISP&gt; <span class="token punctuation">(</span><span class="token car">macroexpand-all</span> <span class="token punctuation">'(</span><span class="token car">mapcar</span> <span class="token quoted-symbol variable symbol">#'cadr</span> <span class="token punctuation">'(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">mapcar</span> <span class="token quoted-symbol variable symbol">#'cadr</span>
        <span class="token punctuation">'(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在这里， <code>cadr</code>  作为 mapcar 的参数使用，compiler macro 就无能为力了.</p> <h3 id="cl-compiler-macroexpand"><a href="#cl-compiler-macroexpand" class="header-anchor">#</a> cl-compiler-macroexpand</h3> <p>但是有时候你可能希望不要打开常规宏，只打开 compiler macro, 这时可以使用 <code>cl-lib</code>  中提
供的 <code>cl-compiler-macroexpand</code></p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code>ELISP&gt; <span class="token punctuation">(</span><span class="token car">cl-compiler-macroexpand</span> <span class="token punctuation">'(</span><span class="token car">cadr</span> <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">car</span>
 <span class="token punctuation">(</span><span class="token car">cdr</span>
  <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code>ELISP&gt; <span class="token punctuation">(</span><span class="token car">cl-compiler-macroexpand</span> <span class="token punctuation">'(</span><span class="token car">if-let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">a</span> <span class="token punctuation">(</span><span class="token car">cadr</span> <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">if-let*</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">a</span>
      <span class="token punctuation">(</span><span class="token car">cadr</span>
       <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    a<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>对比</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code>ELISP&gt; <span class="token punctuation">(</span><span class="token car">macroexpand-all</span> <span class="token punctuation">'(</span><span class="token car">if-let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">a</span> <span class="token punctuation">(</span><span class="token car">cadr</span> <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">let*</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">a</span>
      <span class="token punctuation">(</span><span class="token keyword">and</span> <span class="token boolean">t</span>
           <span class="token punctuation">(</span><span class="token car">car</span>
            <span class="token punctuation">(</span><span class="token car">cdr</span>
             <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token keyword">if</span> a a<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="macrostep"><a href="#macrostep" class="header-anchor">#</a> macrostep</h3> <p><a href="https://github.com/joddie/macrostep" target="_blank" rel="noopener noreferrer">macrostep<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 可以展开 compiler macro, 在
 macrostep 里，compiler macro 和 macro 会用不同的 face 来标记</p> <h2 id="如何编写compiler-macro"><a href="#如何编写compiler-macro" class="header-anchor">#</a> 如何编写 compiler macro</h2> <h3 id="compiler-macro的定义"><a href="#compiler-macro的定义" class="header-anchor">#</a> compiler macro 的定义</h3> <p>compiler-macro 的定义和常规宏一样，是一个返回一个 s 表达式的 lambda, 这个 lambda 接收
的参数数量视用户调用 compiler macro 对应的函数时传入的数量而定。第一个参数固定为要展开的 form,
 其余的参数依次为用户传入函数调用的参数.</p> <h3 id="compiler-macro-symbol-property"><a href="#compiler-macro-symbol-property" class="header-anchor">#</a> <code>compiler-macro</code>  symbol property</h3> <p>为了使 compiler macro 生效，你需要将你定义的 compiler macro 设置为目标函数 symbol 的
 <code>compiler-macro</code>  property 上.</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">defalias</span> <span class="token quoted-symbol variable symbol">'my-list</span> <span class="token quoted-symbol variable symbol">'list</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">put</span> <span class="token quoted-symbol variable symbol">'my-list</span> <span class="token quoted-symbol variable symbol">'compiler-macro</span>
            <span class="token punctuation">(</span><span class="token lambda"><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">form</span> <span class="token rest-vars"><span class="token lisp-marker">&amp;rest</span> <span class="token argument variable">args</span></span></span><span class="token punctuation">)</span></span> <span class="token punctuation">(</span><span class="token keyword">message</span> <span class="token string">&quot;Form: %<span class="token argument">S</span>, ARGS: %S&quot;</span> form args<span class="token punctuation">)</span>
            form<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">cl-compiler-macroexpand</span> <span class="token punctuation">'(</span><span class="token car">my-list</span> <span class="token punctuation">'(</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当我们展开 compiler macro 时，会得到信息</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code>Form: <span class="token punctuation">(</span><span class="token car">my-list</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span>, ARGS: <span class="token punctuation">(</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当你的 compiler macro 只用于一个函数，一般可以忽略掉 form 直接用 args.</p> <h3 id="declare-form"><a href="#declare-form" class="header-anchor">#</a> declare form</h3> <p>在 Emacs 24.4 或更高版本，你可以直接在函数的 <code>declare</code>  form 中指定 compiler macro,</p> <p>详见<a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Declare-Form.html" target="_blank" rel="noopener noreferrer"> manual<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="实战"><a href="#实战" class="header-anchor">#</a> 实战</h2> <h3 id="my-list-函数"><a href="#my-list-函数" class="header-anchor">#</a> <code>my-list*</code>  函数</h3> <p>考虑函数 <code>my-list*</code> , 它接受任意数量的参数，将他们从头用 cons 连接到尾部.</p> <p>我们的初版函数是这样的.</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">my-list*</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token rest-vars"><span class="token lisp-marker">&amp;rest</span> <span class="token argument variable">args</span></span></span><span class="token punctuation">)</span></span>
  <span class="token punctuation">(</span><span class="token keyword">let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">rargs</span> <span class="token punctuation">(</span><span class="token car">reverse</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">(</span><span class="token car">result</span> <span class="token punctuation">(</span><span class="token car">car</span> rargs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token car">dolist</span> <span class="token punctuation">(</span><span class="token car">arg</span> <span class="token punctuation">(</span><span class="token car">cdr</span> rargs<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token car">push</span> arg result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    result<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">my-list*</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span><span class="token punctuation">)</span>                        <span class="token comment">;=&gt; '(1 2 . 3)</span>
<span class="token punctuation">(</span><span class="token car">my-list*</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token punctuation">'(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment">;=&gt; '(1 2 3)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们可以用高阶函数把它变得更简洁</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token keyword">require</span> <span class="token quoted-symbol variable symbol">'cl-lib</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">my-list*</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token rest-vars"><span class="token lisp-marker">&amp;rest</span> <span class="token argument variable">args</span></span></span><span class="token punctuation">)</span></span>
  <span class="token punctuation">(</span><span class="token car">cl-reduce</span> <span class="token quoted-symbol variable symbol">#'cons</span> args <span class="token lisp-property property">:from-end</span> <span class="token boolean">t</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你可能已经看出来， <code>my-list*</code>  等效于手写 <code>(cons arg1 (cons arg2 (cons arg3 ...)))</code> .
 另一方面，我们都知道打开的循环比循环更高效，但是我们完全没有必要为了性能而手写展
开形式，更何况 <code>my-list*</code>  接受任意数量的参数，根本无法直接手写展开.</p> <p>这时候可以利用 compiler macro 生成 sexp 优化我们的 <code>my-list*</code>  函数</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">put</span> <span class="token quoted-symbol variable symbol">'my-list*</span> <span class="token quoted-symbol variable symbol">'compiler-macro</span>
     <span class="token punctuation">(</span><span class="token lambda"><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">_form</span> <span class="token rest-vars"><span class="token lisp-marker">&amp;rest</span> <span class="token argument variable">args</span></span></span><span class="token punctuation">)</span></span>
       <span class="token comment">;; 这里可以用`nreverse', 因为每次调用`(my-list* 1 2 3)'都会生成</span>
       <span class="token comment">;; 新的args, 而`(apply #'my-list* something)' 不会触发compiler macro</span>
       <span class="token punctuation">(</span><span class="token keyword">let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">rargs</span> <span class="token punctuation">(</span><span class="token car">nreverse</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">(</span><span class="token car">head</span> <span class="token punctuation">(</span><span class="token car">pop</span> rargs<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">(</span><span class="token car">result</span> head<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">(</span><span class="token car">dolist</span> <span class="token punctuation">(</span><span class="token car">arg</span> rargs<span class="token punctuation">)</span>
           <span class="token punctuation">(</span><span class="token keyword">setq</span> result <span class="token punctuation">`(</span><span class="token keyword">cons</span> <span class="token splice symbol variable">,arg</span> <span class="token splice symbol variable">,result</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>来尝试一下</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code>ELISP&gt; <span class="token punctuation">(</span><span class="token car">cl-compiler-macroexpand</span> <span class="token punctuation">'(</span><span class="token car">my-list*</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">1</span>
      <span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">2</span>
            <span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">3</span>
                  <span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">4</span>
                        <span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">5</span>
                              <span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">6</span>
                                    <span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">6</span>
                                          <span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">7</span>
                                                <span class="token punctuation">(</span><span class="token keyword">cons</span> <span class="token number">8</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可以看到我们写的 compiler macro 已经如愿展开了.</p> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>在 compiler macro 中，你可以随意修改函数展开的方式，如果操作不当，很可能会导
致直接调用函数与 <code>funcall</code>  调用函数时函数的行为不一致！</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">my-id</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">x</span></span><span class="token punctuation">)</span></span> x<span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token car">put</span> <span class="token quoted-symbol variable symbol">'my-id</span> <span class="token quoted-symbol variable symbol">'compiler-macro</span>
     <span class="token punctuation">(</span><span class="token lambda"><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">_</span> <span class="token argument variable">arg</span></span><span class="token punctuation">)</span></span>
       <span class="token punctuation">`(</span><span class="token car">list</span> <span class="token splice symbol variable">,arg</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">; Malformed compiler macro</span>

<span class="token comment">;; Compiler macro不会在解释运行时展开, 这里使用`my-id'的原始定义.</span>
<span class="token punctuation">(</span><span class="token car">my-id</span> <span class="token number">1</span><span class="token punctuation">)</span>                               <span class="token comment">;=&gt; 1</span>

<span class="token punctuation">(</span><span class="token car">eval</span> <span class="token punctuation">(</span><span class="token car">byte-compile</span> <span class="token punctuation">'(</span><span class="token car">my-id</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">;=&gt; (1) ???</span>

<span class="token punctuation">(</span><span class="token car">eval</span> <span class="token punctuation">(</span><span class="token car">byte-compile</span> <span class="token punctuation">'(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">f</span> <span class="token quoted-symbol variable symbol">#'my-id</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">funcall</span> f <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;=&gt; 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这里利用 funcall 规避了 compiler macro 展开，由于我们的 compiler macro 不规范，导致
 <code>(my-id 1)</code>  和 <code>(funcall f 1)</code>  造成了不一致的结果，请使用 compiler macro 的时候务必
注意，小心不要造成 undefined behaviour.</p></div> <h2 id="广义变量展开中的compiler-macro"><a href="#广义变量展开中的compiler-macro" class="header-anchor">#</a> 广义变量展开中的 compiler macro</h2> <p>由于 <code>macroexpand</code>  可以展开 compiler macro, 因此 <code>setf</code>  也会打开广义变量里的
 compiler macro</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">my-aref</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">arr</span> <span class="token argument variable">idx</span></span><span class="token punctuation">)</span></span>
  <span class="token punctuation">(</span><span class="token car">aref</span> arr idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token car">macroexpand-all</span> <span class="token punctuation">'(</span><span class="token car">setf</span> <span class="token punctuation">(</span><span class="token car">my-aref</span> arr <span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; =&gt; (let* ((v arr)) (\(setf\ my-aref\) 3 v 1))</span>

<span class="token punctuation">(</span><span class="token car">put</span> <span class="token quoted-symbol variable symbol">'my-aref</span> <span class="token quoted-symbol variable symbol">'compiler-macro</span>
     <span class="token punctuation">(</span><span class="token lambda"><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">_</span> <span class="token argument variable">arr</span> <span class="token argument variable">idx</span></span><span class="token punctuation">)</span></span>
       <span class="token punctuation">`(</span><span class="token car">aref</span> <span class="token splice symbol variable">,arr</span> <span class="token splice symbol variable">,idx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token car">macroexpand-all</span> <span class="token punctuation">'(</span><span class="token car">setf</span> <span class="token punctuation">(</span><span class="token car">my-aref</span> arr <span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; =&gt; (let* ((v arr)) (aset v 1 3))</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我们用 <code>my-aref</code>  简单包裹了 <code>aref</code>  函数，然而 Emacs 并不会进入我们的函数定义去查看我们
实际进行的动作，emacs 只会去寻找 <code>my-aref</code>  的 gv-setter, 并且在找不到的情况下使用了
 setter 的默认值 <code>(setf my-aref)</code> (当然这里我们没有定义),
 而使用了 compiler macro 后，我们给编译器足够的提示，成功 <code>my-aref</code>  被打开成对应的
 <code>aref</code>  Emacs 已经定义了 <code>aref</code>  的 gv-setter <code>aset</code> ,  <code>setf</code>  就可以直接使用 aset 作为
 my-aref 的 gv-setter</p> <h2 id="define-inline"><a href="#define-inline" class="header-anchor">#</a> define-inline</h2> <p>为了更好的利用 compiler macro, Emacs 25 提供了 <code>inline.el</code> , 作为 compiler 的上层包装，
 协助用户更好更简单写出安全的内联函数.</p> <h3 id="inline-quote"><a href="#inline-quote" class="header-anchor">#</a> inline-quote</h3> <p>用 <code>define-inline</code>  定义函数类似于定义一个宏，不过用 <code>inline-quote</code>  代替  <code>`</code> 
 在 <code>inline-quote</code>  中，你只能使用 <code>,</code>  而不能使用 <code>,@</code> , 这是为了防止生成的 compiler
macro 意外的破坏函数语义.</p> <p>用 <code>define-inline</code>  重新定义刚才提到的 <code>my-aref</code></p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token keyword">require</span> <span class="token quoted-symbol variable symbol">'inline</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token car">define-inline</span> my-aref-inline <span class="token punctuation">(</span><span class="token car">arr</span> idx<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">inline-quote</span> <span class="token punctuation">(</span><span class="token car">aref</span> <span class="token splice symbol variable">,arr</span> <span class="token splice symbol variable">,idx</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">my-aref-inline</span> <span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> 3<span class="token punctuation">]</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">;=&gt; 1</span>
<span class="token punctuation">(</span><span class="token car">macroexpand-all</span> <span class="token punctuation">'(</span><span class="token car">setf</span> <span class="token punctuation">(</span><span class="token car">my-aref-inline</span> arr <span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;=&gt; (let* ((v arr)) (aset v 1 3))</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>用 <code>macroexpand-all</code>  直接打开我们定义 <code>my-aref-inline</code>  的过程，得到</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">progn</span>
  <span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">my-aref-inline</span>
      <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">arr</span> <span class="token argument variable">idx</span></span><span class="token punctuation">)</span></span>
    <span class="token punctuation">(</span><span class="token declare keyword">declare</span>
     <span class="token punctuation">(</span><span class="token car">compiler-macro</span> my-aref-inline--inliner<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token car">aref</span> arr idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token lisp-property property">:autoload-end</span>
  <span class="token punctuation">(</span><span class="token car">eval-and-compile</span>
    <span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">my-aref-inline--inliner</span>
        <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">inline--form</span> <span class="token argument variable">arr</span> <span class="token argument variable">idx</span></span><span class="token punctuation">)</span></span>
      <span class="token punctuation">(</span><span class="token car">ignore</span> inline--form<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token car">catch</span> <span class="token quoted-symbol variable symbol">'inline--just-use</span>
        <span class="token punctuation">(</span><span class="token car">list</span> <span class="token quoted-symbol variable symbol">'aref</span> arr idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看出来底层还是用的 compiler macro 的机制.</p> <h3 id="inline-letevals"><a href="#inline-letevals" class="header-anchor">#</a> inline-letevals</h3> <p>考虑函数</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">pow2</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">num</span></span><span class="token punctuation">)</span></span>
  <span class="token punctuation">(</span><span class="token car">*</span> num num<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如何用 <code>define-inline</code>  定义其内联版本？</p> <p>尝试直接用 <code>inline-quote</code></p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">define-inline</span> pow2-inline <span class="token punctuation">(</span><span class="token car">num</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">inline-quote</span> <span class="token punctuation">(</span><span class="token car">*</span> <span class="token splice symbol variable">,num</span> <span class="token splice symbol variable">,num</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token car">pow2-inline</span> <span class="token number">3</span><span class="token punctuation">)</span>                         <span class="token comment">;=&gt; 9</span>
<span class="token punctuation">(</span><span class="token car">pow2-inline</span> <span class="token number">2</span><span class="token punctuation">)</span>                         <span class="token comment">;=&gt; 4</span>
<span class="token punctuation">(</span><span class="token car">eval</span> <span class="token punctuation">(</span><span class="token car">byte-compile</span> <span class="token punctuation">'(</span><span class="token car">pow2-inline</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">;=&gt; 4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>看起来没有问题，继续测试</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">my-side-effect-2</span> <span class="token punctuation">(</span><span class="token arguments"></span><span class="token punctuation">)</span></span>
  <span class="token string">&quot;Do a message, and return 2.&quot;</span>
  <span class="token punctuation">(</span><span class="token keyword">message</span> <span class="token string">&quot;Side effect!&quot;</span><span class="token punctuation">)</span>
  <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token car">eval</span> <span class="token punctuation">(</span><span class="token car">byte-compile</span> <span class="token punctuation">'(</span><span class="token car">pow2-inline</span> <span class="token punctuation">(</span><span class="token car">my-side-effect-2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;=&gt; 4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里，message &quot;Side effect!&quot; 被发送了两次，我们用 <code>macroexpand</code>  打开 <code>pow2-inline</code>  看
看</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">*</span>
 <span class="token punctuation">(</span><span class="token car">my-side-effect-2</span><span class="token punctuation">)</span>
 <span class="token punctuation">(</span><span class="token car">my-side-effect-2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>看起来我们的参数 <code>(my-side-effect-2)</code>  被直接内联到了 <code>*</code>  的两个参数位置里，造成
 <code>my-side-effect-2</code>  被求值两次，这显然不是我们想要的结果.</p> <p>对于这种情况， <code>define-inline</code>  为我们提供了 <code>inline-letevals</code>  来控制一个表达式只被
计算一次</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">define-inline</span> pow2-inline-2 <span class="token punctuation">(</span><span class="token car">num</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">inline-letevals</span> <span class="token punctuation">(</span><span class="token car">num</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token car">inline-quote</span>
     <span class="token punctuation">(</span><span class="token car">*</span> <span class="token splice symbol variable">,num</span> <span class="token splice symbol variable">,num</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token car">eval</span> <span class="token punctuation">(</span><span class="token car">byte-compile</span> <span class="token punctuation">'(</span><span class="token car">pow2-inline-2</span> <span class="token punctuation">(</span><span class="token car">my-side-effect-2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;=&gt; 只有一次&quot;Side Effect!&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>展开 <code>pow2-inline-2</code>  的调用</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">print-gensym</span> <span class="token boolean">t</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token car">print-circle</span> <span class="token boolean">t</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">prin1-to-string</span> <span class="token punctuation">(</span><span class="token car">macroexpand-all</span> <span class="token punctuation">'(</span><span class="token car">pow2-inline-2</span> <span class="token punctuation">(</span><span class="token car">my-side-effect-2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">;; =&gt; &quot;(let* ((#1=#:num (my-side-effect-2))) (* #1# #1#))&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看出来 <code>inline-letevals</code>  类似与我们编写 macro 时用 let 和 gensym 保护 expression 的方
式.</p> <h2 id="faq"><a href="#faq" class="header-anchor">#</a> FAQ</h2> <h3 id="为什么不直接使用macro"><a href="#为什么不直接使用macro" class="header-anchor">#</a> 为什么不直接使用 macro?</h3> <p>从语法上看 macro 不能作为高阶函数的参数使用 (当然你可以拐着弯用 lambda 包裹 macro). 而
 function 可以.</p> <p>compiler macro 和 macro 一样，会被 Emacs 的 Eager macroexpansion 机制打开.</p> <p>在老版本的 Emacs 中，有人喜欢用宏替代内联函数，这在新版本中的 Emacs 完全没有必要，函
数和宏完全是两种不同语义的东西，如果你需要内联函数优化，请使用 compiler macro, 或
者 <code>define-inline</code>  这种上层包装.</p> <h3 id="用compiler-macro做内联和使用defsubst的内联有什么区别"><a href="#用compiler-macro做内联和使用defsubst的内联有什么区别" class="header-anchor">#</a> 用 compiler macro 做内联和使用 <code>defsubst</code>  的内联有什么区别？</h3> <p><code>defsubst</code>  是另一种定义内联函数的方式，对比 compiler macro,  <code>defsubst</code>  内联的方式更
为保守.</p> <p><code>defsubst</code>  无法用 <code>macroexpand</code>  展开，因此 <code>defsubst</code>  定义的 inline function 不能作为
 <code>setf</code>  的 form.</p> <p>比如， <code>defsubst</code>  会保持 lisp function 对 argument 严格从左到右求值的逻辑。同样也会建
立函数专有的变量作用域。比如上文用来举例的 <code>pow2-inline</code> , 用 <code>defsubst</code>  可以直接定
义为</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token car">defsubst</span> pow2-subst <span class="token punctuation">(</span><span class="token car">num</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">*</span> num num<span class="token punctuation">)</span><span class="token punctuation">)</span>
  
<span class="token punctuation">(</span><span class="token car">eval</span> <span class="token punctuation">(</span><span class="token car">byte-compile</span> <span class="token punctuation">'(</span><span class="token car">pow2-subst</span> <span class="token punctuation">(</span><span class="token car">my-side-effect-2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">;只有一次&quot;Side Effect!&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用 compiler macro 时，求值策略是由用户自行决定的.</p> <div class="language-lisp line-numbers-mode"><pre class="language-lisp"><code><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">say-is</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">somthing</span> <span class="token argument variable">type</span></span><span class="token punctuation">)</span></span>
  <span class="token punctuation">(</span><span class="token keyword">message</span> <span class="token string">&quot;%s is %s&quot;</span> something type<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token car">define-inline</span> simple-case <span class="token punctuation">(</span><span class="token car">something</span> type<span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token car">inline-letevals</span> <span class="token punctuation">(</span><span class="token car">something</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token car">inline-quote</span>
     <span class="token punctuation">(</span><span class="token car">cl-case</span> <span class="token splice symbol variable">,something</span>
       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">donkey</span> <span class="token punctuation">(</span><span class="token car">say-is</span> <span class="token splice symbol variable">,something</span> <span class="token splice symbol variable">,type</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">rabbit</span> <span class="token punctuation">(</span><span class="token car">say-is</span> <span class="token splice symbol variable">,something</span> <span class="token splice symbol variable">,type</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里我们没有用 <code>inline-letevals</code>  保护 <code>type</code>  变量，因为我们知道 cl-case 的两个分支不可
能同时执行，而 type 被作为函数 <code>say-is</code>  的参数， <code>say-is</code>  会将其 eval. 这样我们就达成了
类似 <code>lazy evaluation</code>  的效果</p> <h2 id="相关讨论"><a href="#相关讨论" class="header-anchor">#</a> 相关讨论</h2> <p><a href="https://emacs-china.org/t/elisp-compiler-macro/10552" target="_blank" rel="noopener noreferrer">见 emacs-china 论坛<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <hr> <!----></div> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#什么是-compiler-macro" title="什么是 compiler macro">什么是 compiler macro</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#如何察看compiler-macro的展开结果" title="如何察看compiler macro的展开结果">如何察看compiler macro的展开结果</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#macroexpand" title="macroexpand">macroexpand</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#cl-compiler-macroexpand" title="cl-compiler-macroexpand">cl-compiler-macroexpand</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#macrostep" title="macrostep">macrostep</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#如何编写compiler-macro" title="如何编写compiler macro">如何编写compiler macro</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#compiler-macro的定义" title="compiler macro的定义">compiler macro的定义</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#compiler-macro-symbol-property" title="compiler-macro symbol property">compiler-macro symbol property</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#declare-form" title="declare form">declare form</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#实战" title="实战">实战</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#my-list-函数" title="my-list* 函数">my-list* 函数</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#广义变量展开中的compiler-macro" title="广义变量展开中的compiler macro">广义变量展开中的compiler macro</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#define-inline" title="define-inline">define-inline</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#inline-quote" title="inline-quote">inline-quote</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#inline-letevals" title="inline-letevals">inline-letevals</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#faq" title="FAQ">FAQ</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#为什么不直接使用macro" title="为什么不直接使用macro?">为什么不直接使用macro?</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#用compiler-macro做内联和使用defsubst的内联有什么区别" title="用compiler macro做内联和使用defsubst的内联有什么区别?">用compiler macro做内联和使用defsubst的内联有什么区别?</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#相关讨论" title="相关讨论">相关讨论</a></div></div></div></div> <footer class="footer" data-v-5317f8db><div class="footer-left-wrap" data-v-5317f8db><ul class="contact" data-v-5317f8db></ul></div> <div class="footer-right-wrap" data-v-5317f8db><ul class="copyright" data-v-5317f8db></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1bc9c4b2.js" defer></script><script src="/assets/js/4.3623162e.js" defer></script><script src="/assets/js/5.01fa82bf.js" defer></script><script src="/assets/js/13.82bd8097.js" defer></script>
  </body>
</html>
